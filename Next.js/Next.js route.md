# NEXT.js Routing

13 버전 이전에는 page 라우팅 기능을 사용했으며, 13 버전 이후로는 app 라우팅 기능이 도입됐습니다.

## 13버전

`공유 레이아웃`, `중첩 라우팅`, `로딩 상태`, `오류 처리` 등을 지원하는 `React Server Components`를 기반으로 새로운 app 라우터를 도입했습니다.

Next.js는 파일 시스템 기반 라우터를 사용합니다.

## 파일 시스템 기반 라우터

- **폴더**는 경로를 정의하는 데 사용됩니다. 경로는 `루트 폴더`부터 파일이 포함된 최종 `리프 폴더`까지 파일 시스템 계층 구조를 따라가는 중첩된 폴더의 단일 경로입니다.
- **파일**은 경로 세그먼트에 표시되는 UI를 만드는데 사용됩니다.

### 경로 구간

경로의 각 폴더는 경로 세그먼트를 나타냅니다. 각 경로 세그먼트는 URL 경로의 해당 세그먼트에 맵핑됩니다.

### 중첩 경로

중첩된 경로를 만들려면 폴더를 서로 중첩하면 됩니다.

![공식문서 경로관련 이미지](https://github.com/homile/TIL/assets/56163157/834b6ec2-5074-440c-b877-179eb59ed62c)

### 파일 규칙

중첩된 경로에서 특정 동작으로 UI를 생성하기 위한 특수 파일 세트를 제공합니다.

| 속성| 설명 |
| --- | --- |
| layout | 세그먼트 및 해당 하위 항목에 대한 공유 UI |
| page | 경로의 고유한 UI 및 경로에 공개적으로 액세스 가능 |
| loading | 세그먼트 및 해당 하위 항목에 대한 UI 로드 중 |
| not-found | 세그먼트 및 해당 하위 항목에 대한 UI를 찾을 수 없습니다. |
| error | 세그먼트 및 해당 하위 항목에 대한 오류 UI |
| global-error | 전역 오류 UI |
| route | 서버 측 API 엔드포인트 |
| template | 전문적으로 다시 렌더링된 레이아웃 UI |
| default | 병렬 경로에 대한 대체 UI |

![공식문서 Route 이미지](https://github.com/homile/TIL/assets/56163157/610d4188-abd3-4bc8-a342-8665c8986dc2)

---

## React Server Components

서버에서 렌더링하고 선택저으로 캐싱할 수 있는 UI를 작성할 수 있습니다.
스트리밍 및 부분 렌더링을 활성화하기 위해 렌더링 작업이 route segments 별로 추가로 분할되며 세 가지 서버 렌더링 전략이 있습니다.

### 1. **정적 렌더링(기본값)**

- 빌드 시 렌더링되거나 데이터 재검증 후 백그라운에서 렌더링 되며, 결과는 캐시되어 CDN으로 푸시될 수 있습니다.
- 경로에 사용자에게 개인화되지 않은 데이터가 있고, 빌드 시 알 수 있는 데이터가 있는 경우에 유용합니다.

### 2. **동적 렌더링**

- 요청 시 각 사용자에게 대한 경로가 렌더링 됩니다.
- 경로에 사용자에게 맞춤화된 데이터가 있거나 쿠키나 URL의 검색 매개변수와 같이 요청 시에만 알 수 있는 정보가 있는 경우에 유용합니다.

### 3. **스트리밍**

- 서버에서 UI를 점진적으로 렌더링 할 수 있도록 합니다.
- 작업은 여러 단위로 분할되어 준비가 되면 클라이언트로 스트리밍 됩니다.
- 이를 통해서 사용자는 전체 콘텐츠의 렌더링이 완료되기 전에 페이지의 일부를 즉시 볼 수 있습니다.
- Next.js의 app 라우터에 내장되어 있습니다.
- 초기 페이지 로딩 성능뿐만 아니라 전체 경로 렌더링을 차단하는 느린 데이터 가져오기에 의존하는 UI를 모두 개선하는데 도움이 됩니다.

---

## 정적 라우팅

이전에는 pages 폴더 밑에 라우팅을 설정할 수 있었는데 app 라우팅 기능이 추가된 이후로는 `src/app` 폴더 아래 라우팅 하고 싶은 폴더명을 생성 후 `page.js` 파일을 생성하여 라우팅합니다.

아래와 같이 `src/app/create`로 폴더를 생성하여 page.js 파일을 추가할 경우 라우팅 경로가 생기게 됩니다.

```
📦src
 ┗ 📂app
 ┃ ┣ 📂create
 ┃ ┃ ┣ 📜layout.js
 ┃ ┃ ┗ 📜page.js
 ┃ ┣ 📜favicon.ico
 ┃ ┣ 📜globals.css
 ┃ ┣ 📜layout.js
 ┃ ┗ 📜page.js
```

---

## 동적 라우팅

블로그를 예시로 들면 https://homile.tistory.com/306 와 같이 306 이라는 게시글의 ID 값이 들어가게 되는데 이를 하나하나 정적으로 페이지를 만들게 될 경우에 작업에 소요되는 시간과 예상치 못한 에러를 마주했을 때 해결하기 어려운 부분이 있습니다.

이때, 사용하는 것이 동적 라우팅 입니다.

NEXT.js에서 동적 라우팅을 하는 방법은 정적 라우팅과 순서는 비슷하지만 parameter에 담긴 값들중 어떤 값으로 동적 라우팅을 할지 폴더로 구분하여 만들수 있습니다.

저는 id 값으로 동적 라우팅을 진행할 것이기 때문에 `read/[id]/page.js` 로 구성하여 id 값이 다를 때 마다 화면이 변경되도록 구성하였습니다.

```
📦app
 ┣ 📂create // 정적라우팅
 ┃ ┣ 📜layout.js
 ┃ ┗ 📜page.js
 ┣ 📂read  // 동적 라우팅
 ┃ ┗ 📂[id]
 ┃ ┃ ┗ 📜page.js
 ┣ 📜favicon.ico
 ┣ 📜globals.css
 ┣ 📜layout.js
 ┗ 📜page.js
```

---

## **Colocation**

13버전 이전의 page 방식의 라우터에서는 pages 폴더 안에 components 같은 폴더를 만들어도 페이지로 인식되었지만 app 방식의 라우터에서는 아래와 같이 페이지로 인식하지 않습니다.

특수 파일 외에 **app directory**의 **folder** 내에 자신의 파일(e.g. components, styles, test, etc)을 같은 위치에 배치할 수 있는 옵션이 있습니다.

page.js 또는 route.js 폴더가 경로를 정의하는 동안 반환된 내용이나 공개적으로 주소를 지저할 수 있는 내용만 정의되기 때문입니다.

![공식문서 Colocation 이미지](https://github.com/homile/TIL/assets/56163157/da703d34-6625-41a5-a9a4-3d989d8e4e8d)

---

## 고급 라우팅 패턴

아래와 같은 **`고급 라우팅 패턴`**을 사용하면 더 풍부하고 복잡한 UI를 구축할 수 있습니다.

- `**병렬 경로**` : 독립적으로 탐색할 수 있는 동일한 보기에 두 개 이상의 페이지를 동시에 표시할 수 있습니다. 자체 하위 탐색이 있는 분할 보기에 사용할 수 있습니다. (e.g. dashboards)
  - 동일한 레이아웃에서 하나 이상의 페이지를 동시에 또는 조건부로 렌더링할 수 있습니다.
  - 대시보드 및 소셜 사이트의 피드와 같이 매우 동적인 앱 섹션의 경우 병렬 라우팅을 사용하여 복잡한 라우팅 패턴을 구현할 수 있습니다.
    ![공식문서 routes](https://github.com/homile/TIL/assets/56163157/7018f037-4ef1-4ba9-9b05-7a43a57d2bd7)
  - 경로가 독립적으로 스트리밍될 때 각 경로에 대해 독립적인 오류 및 로드 상태를 정의할 수 있습니다.
    ![공식문서 routes](https://github.com/homile/TIL/assets/56163157/34fef1a5-ab27-40f4-a2ea-97cbb3a061d8)
  - 인증 상태와 같은 특정 조건에 따라 슬롯을 조건부로 렌더링 할 수도 있습니다. 동일한 URL에서 완전히 분리된 코드를 사용할 수 있습니다.
    ![공식문서 routes](https://github.com/homile/TIL/assets/56163157/59126bc5-a22c-49ef-b207-ac11a691aaac)
  - 폴더명 앞에 @를 붙이는 이유
    - 유니크한 경로를 생성하기 위해서 사용합니다.
- `**Intercepting Routs**` : 경로를 가로채서 다른 경로의 맥락에서 표시할 수 있습니다. 현재 페이지의 컨텍스트를 유지하는 것이 중요할 때 이를 사용할 수 있습니다. (e.g. 하나의 작업을 편집하거나 피드에서 사진을 확장하는 동안 모든 작업을 봅니다.)
  - 경로를 가로채서 현재 레이아웃 내 애플리케이션의 다른 부분에서 경로를 로드할 수 있습니다. 사용자가 컨텍스트로 전환하지 않고도 경로의 내용을 표시하려는 경우에 유용할 수 있습니다.
  - 피드에서 사진을 클릭하면 피드에 오버레이되어 사진을 모달로 표시할 수 있습니다.
    `/photo/123`경로를 가로채서 URL을 마스크하고 `/feed`를 오버레이 합니다.
    ![intercepting-routes-soft-navigate](https://github.com/homile/TIL/assets/56163157/6348e8f8-e601-42d1-b284-796175bf51ec)
  - 공유 가능한 URL을 클릭하거나 페이지를 새로고침 했을 때는 모달 대신 전체 사진 페이지가 렌더링 되어야 합니다.
    ![intercepting-routes-hard-navigate](https://github.com/homile/TIL/assets/56163157/87afe7a6-a6f1-479d-9d29-0f4f943f7e97)
  - **Convention(경로 차단 규칙)**
    - 상대 경로 규칙과 유사하지만 세그먼트에 대한 것입니다.
    - `(.)` 동일한 수준의 세그먼트를 일치
    - `(..)` 한 수준 위의 세그먼트와 일치
    - `(..)(..)` 두 수준 위의 세그먼트와 일치
    - `(...)` **root app** 디렉터리의 세그먼트를 일치
      디렉터리를 생성하여 photo 세그먼트 내에서 `feed(..)photo` 세그먼트를 가로챌 수 있습니다.
      ![intercepted-routes-modal-example](https://github.com/homile/TIL/assets/56163157/bd280666-74e3-4298-8d1a-0c064d0ceec1)
  - **e.g. Modal**
    - 가로채기를 사용하여 모달을 생성할 수 있습니다.
    - URL을 통해 모달 콘텐츠 공유
    - 모달을 닫는 대신 페이지를 새로고침할 때 컨텍스트를 유지합니다.
    - 이전 경로로 이동하는 대신 뒤로 탐색 시 모달을 닫습니다.
    - 앞으로 탐색에서 모달을 다시 엽니다.
    - **e.g 로그인 Modal, 장바구니 Modal**
      ![intercepted-routes-files](https://github.com/homile/TIL/assets/56163157/fa7cd739-086c-49e5-9aa2-12d1fc5b53ae)
